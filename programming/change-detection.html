<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Change Detection - Unofficial Bevy Cheat Book</title>
        <!-- Custom HTML head -->
<script async defer src="https://buttons.github.io/buttons.js"></script>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../nagbar.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../builtins.html">List of Bevy Builtins</a></li><li class="chapter-item expanded affix "><a href="../glossary.html">Alphabetical Glossary</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../setup.html"><strong aria-hidden="true">1.</strong> Bevy Setup Tips</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../setup/bevy-git.html"><strong aria-hidden="true">1.1.</strong> Using bleeding-edge Bevy (main)</a></li><li class="chapter-item expanded "><a href="../setup/editor.html"><strong aria-hidden="true">1.2.</strong> Text Editor / IDE</a></li><li class="chapter-item expanded "><a href="../setup/bevy-tools.html"><strong aria-hidden="true">1.3.</strong> Dev Tools and Editors for Bevy</a></li><li class="chapter-item expanded "><a href="../setup/unofficial-plugins.html"><strong aria-hidden="true">1.4.</strong> 3rd-party Plugins</a></li><li class="chapter-item expanded "><a href="../setup/bevy-config.html"><strong aria-hidden="true">1.5.</strong> Customizing Bevy (features, modularity)</a></li></ol></li><li class="chapter-item expanded "><a href="../pitfalls.html"><strong aria-hidden="true">2.</strong> Common Pitfalls</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../pitfalls/build-errors.html"><strong aria-hidden="true">2.1.</strong> Strange compile errors from Bevy or dependencies</a></li><li class="chapter-item expanded "><a href="../pitfalls/performance.html"><strong aria-hidden="true">2.2.</strong> Slow Performance</a></li><li class="chapter-item expanded "><a href="../pitfalls/into-system.html"><strong aria-hidden="true">2.3.</strong> Error adding function as system</a></li><li class="chapter-item expanded "><a href="../pitfalls/ui-camera.html"><strong aria-hidden="true">2.4.</strong> UI is not displaying</a></li><li class="chapter-item expanded "><a href="../pitfalls/2d-camera-z.html"><strong aria-hidden="true">2.5.</strong> 2D objects not displaying</a></li><li class="chapter-item expanded "><a href="../pitfalls/3d-not-rendering.html"><strong aria-hidden="true">2.6.</strong> 3D objects not displaying</a></li><li class="chapter-item expanded "><a href="../pitfalls/split-borrows.html"><strong aria-hidden="true">2.7.</strong> Borrow multiple fields from struct</a></li><li class="chapter-item expanded "><a href="../pitfalls/time.html"><strong aria-hidden="true">2.8.</strong> Jittering Time (choppy movement/animation)</a></li><li class="chapter-item expanded "><a href="../pitfalls/ui-y-up.html"><strong aria-hidden="true">2.9.</strong> UI layout is inverted</a></li><li class="chapter-item expanded "><a href="../pitfalls/uv-coordinates.html"><strong aria-hidden="true">2.10.</strong> Textures/Images are flipped</a></li></ol></li><li class="chapter-item expanded "><a href="../features.html"><strong aria-hidden="true">3.</strong> Bevy Game Engine Core</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../features/coords.html"><strong aria-hidden="true">3.1.</strong> Coordinate System</a></li><li class="chapter-item expanded "><a href="../features/transforms.html"><strong aria-hidden="true">3.2.</strong> Transforms</a></li><li class="chapter-item expanded "><a href="../features/parent-child.html"><strong aria-hidden="true">3.3.</strong> Parent/Child Hierarchies</a></li><li class="chapter-item expanded "><a href="../features/fixed-timestep.html"><strong aria-hidden="true">3.4.</strong> Fixed Timestep</a></li><li class="chapter-item expanded "><a href="../features/assets.html"><strong aria-hidden="true">3.5.</strong> Assets</a></li><li class="chapter-item expanded "><a href="../features/hot-reload.html"><strong aria-hidden="true">3.6.</strong> Hot-Reloading Assets</a></li><li class="chapter-item expanded "><a href="../features/file-formats.html"><strong aria-hidden="true">3.7.</strong> File Format Support</a></li><li class="chapter-item expanded "><a href="../features/input-handling.html"><strong aria-hidden="true">3.8.</strong> Input Handling</a></li><li class="chapter-item expanded "><a href="../features/gltf.html"><strong aria-hidden="true">3.9.</strong> 3D Models (GLTF)</a></li><li class="chapter-item expanded "><a href="../features/audio.html"><strong aria-hidden="true">3.10.</strong> Audio</a></li></ol></li><li class="chapter-item expanded "><a href="../programming.html"><strong aria-hidden="true">4.</strong> Bevy Programming Framework</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../programming/ecs-intro.html"><strong aria-hidden="true">4.1.</strong> Intro to ECS</a></li><li class="chapter-item expanded "><a href="../programming/ec.html"><strong aria-hidden="true">4.2.</strong> Entities and Components</a></li><li class="chapter-item expanded "><a href="../programming/res.html"><strong aria-hidden="true">4.3.</strong> Resources</a></li><li class="chapter-item expanded "><a href="../programming/systems.html"><strong aria-hidden="true">4.4.</strong> Systems</a></li><li class="chapter-item expanded "><a href="../programming/queries.html"><strong aria-hidden="true">4.5.</strong> Queries</a></li><li class="chapter-item expanded "><a href="../programming/commands.html"><strong aria-hidden="true">4.6.</strong> Commands</a></li><li class="chapter-item expanded "><a href="../programming/events.html"><strong aria-hidden="true">4.7.</strong> Events</a></li><li class="chapter-item expanded "><a href="../programming/app-builder.html"><strong aria-hidden="true">4.8.</strong> App Builder (fn main)</a></li><li class="chapter-item expanded "><a href="../programming/quit.html"><strong aria-hidden="true">4.9.</strong> Quit the App</a></li><li class="chapter-item expanded "><a href="../programming/local.html"><strong aria-hidden="true">4.10.</strong> Local Resources</a></li><li class="chapter-item expanded "><a href="../programming/plugins.html"><strong aria-hidden="true">4.11.</strong> Plugins</a></li><li class="chapter-item expanded "><a href="../programming/system-order.html"><strong aria-hidden="true">4.12.</strong> System Order of Execution</a></li><li class="chapter-item expanded "><a href="../programming/system-sets.html"><strong aria-hidden="true">4.13.</strong> System Sets</a></li><li class="chapter-item expanded "><a href="../programming/change-detection.html" class="active"><strong aria-hidden="true">4.14.</strong> Change Detection</a></li><li class="chapter-item expanded "><a href="../programming/states.html"><strong aria-hidden="true">4.15.</strong> States</a></li><li class="chapter-item expanded "><a href="../programming/run-criteria.html"><strong aria-hidden="true">4.16.</strong> Run Criteria</a></li><li class="chapter-item expanded "><a href="../programming/labels.html"><strong aria-hidden="true">4.17.</strong> Labels</a></li><li class="chapter-item expanded "><a href="../programming/stages.html"><strong aria-hidden="true">4.18.</strong> Stages</a></li><li class="chapter-item expanded "><a href="../programming/world.html"><strong aria-hidden="true">4.19.</strong> [WIP] Direct World/ECS Access</a></li><li class="chapter-item expanded "><a href="../programming/exclusive.html"><strong aria-hidden="true">4.20.</strong> [WIP] Exclusive Systems</a></li><li class="chapter-item expanded "><a href="../programming/removal-detection.html"><strong aria-hidden="true">4.21.</strong> Removal Detection</a></li><li class="chapter-item expanded "><a href="../programming/query-sets.html"><strong aria-hidden="true">4.22.</strong> Query Sets</a></li><li class="chapter-item expanded "><a href="../programming/system-chaining.html"><strong aria-hidden="true">4.23.</strong> System Chaining</a></li><li class="chapter-item expanded "><a href="../programming/sub-apps.html"><strong aria-hidden="true">4.24.</strong> [WIP] Sub-Apps</a></li><li class="chapter-item expanded "><a href="../programming/non-send.html"><strong aria-hidden="true">4.25.</strong> [WIP] Non-Send</a></li><li class="chapter-item expanded "><a href="../programming/system-tests.html"><strong aria-hidden="true">4.26.</strong> Writing Tests for Systems</a></li></ol></li><li class="chapter-item expanded "><a href="../patterns.html"><strong aria-hidden="true">5.</strong> Programming Patterns</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../patterns/generic-systems.html"><strong aria-hidden="true">5.1.</strong> Generic Systems</a></li><li class="chapter-item expanded "><a href="../patterns/manual-event-clear.html"><strong aria-hidden="true">5.2.</strong> Manual Event Clearing</a></li></ol></li><li class="chapter-item expanded "><a href="../cookbook.html"><strong aria-hidden="true">6.</strong> Bevy Cookbook</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cookbook/clear-color.html"><strong aria-hidden="true">6.1.</strong> Change the Background Color</a></li><li class="chapter-item expanded "><a href="../cookbook/print-framerate.html"><strong aria-hidden="true">6.2.</strong> Show Framerate in Console</a></li><li class="chapter-item expanded "><a href="../cookbook/mouse-grab.html"><strong aria-hidden="true">6.3.</strong> Grab the Mouse</a></li><li class="chapter-item expanded "><a href="../cookbook/window-icon.html"><strong aria-hidden="true">6.4.</strong> Setting the Window Icon</a></li><li class="chapter-item expanded "><a href="../cookbook/assets-ready.html"><strong aria-hidden="true">6.5.</strong> Track Assets Loading</a></li><li class="chapter-item expanded "><a href="../cookbook/cursor2world.html"><strong aria-hidden="true">6.6.</strong> Convert cursor to world coordinates</a></li><li class="chapter-item expanded "><a href="../cookbook/custom-projection.html"><strong aria-hidden="true">6.7.</strong> Custom Camera Projection</a></li><li class="chapter-item expanded "><a href="../cookbook/pan-orbit-camera.html"><strong aria-hidden="true">6.8.</strong> Pan+Orbit Camera</a></li><li class="chapter-item expanded "><a href="../cookbook/print-resources.html"><strong aria-hidden="true">6.9.</strong> List All Resource Types</a></li></ol></li><li class="chapter-item expanded "><a href="../platforms.html"><strong aria-hidden="true">7.</strong> Bevy on Different Platforms</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../platforms/linux.html"><strong aria-hidden="true">7.1.</strong> Linux Desktop</a></li><li class="chapter-item expanded "><a href="../platforms/macos.html"><strong aria-hidden="true">7.2.</strong> macOS Desktop</a></li><li class="chapter-item expanded "><a href="../platforms/windows.html"><strong aria-hidden="true">7.3.</strong> Windows Desktop</a></li><li class="chapter-item expanded "><a href="../platforms/wasm.html"><strong aria-hidden="true">7.4.</strong> Browser (WebAssembly)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../platforms/wasm/panic-console.html"><strong aria-hidden="true">7.4.1.</strong> Panic Messages</a></li><li class="chapter-item expanded "><a href="../platforms/wasm/size-opt.html"><strong aria-hidden="true">7.4.2.</strong> Optimize for Size</a></li><li class="chapter-item expanded "><a href="../platforms/wasm/gh-pages.html"><strong aria-hidden="true">7.4.3.</strong> Hosting on GitHub Pages</a></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../contributing.html">Contributing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Unofficial Bevy Cheat Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="change-detection"><a class="header" href="#change-detection">Change Detection</a></h1>
<p>Relevant official examples:
<a href="https://github.com/bevyengine/bevy/blob/latest/examples/ecs/change_detection.rs"><code>change_detection</code></a>.</p>
<hr />
<p>Bevy allows you to easily detect when data is changed. You can use this to
perform actions in response to changes.</p>
<h2 id="components"><a class="header" href="#components">Components</a></h2>
<p>Use <a href="./queries.html#query-filters">query filters</a>:</p>
<ul>
<li><code>Added&lt;T&gt;</code>: detect new component instances
<ul>
<li>if the component was added to an existing entity</li>
<li>if a new entity with the component was spawned</li>
</ul>
</li>
<li><code>Changed&lt;T&gt;</code>: detect component instances that have been changed
<ul>
<li>triggers when the component is accessed mutably</li>
<li>also triggers if the component is newly-added (as per <code>Added</code>)</li>
</ul>
</li>
</ul>
<p>(If you want to react to removals, see the page on <a href="./removal-detection.html">removal
detection</a>. It works differently and is much
trickier to use.)</p>
<pre><code class="language-rust no_run noplayground">/// Print the stats of friendly players when they change
fn debug_stats_change(
    query: Query&lt;
        // components
        (&amp;Health, &amp;PlayerXp),
        // filters
        (Without&lt;Enemy&gt;, Or&lt;(Changed&lt;Health&gt;, Changed&lt;PlayerXp&gt;)&gt;), 
    &gt;,
) {
    for (health, xp) in query.iter() {
        eprintln!(
            &quot;hp: {}+{}, xp: {}&quot;,
            health.hp, health.extra, xp.0
        );
    }
}

/// detect new enemies and print their health
fn debug_new_hostiles(
    query: Query&lt;(Entity, &amp;Health), Added&lt;Enemy&gt;&gt;,
) {
    for (entity, health) in query.iter() {
        eprintln!(&quot;Entity {:?} is now an enemy! HP: {}&quot;, entity, health.hp);
    }
}
</code></pre>
<p><code>Changed</code> detection is triggered by <code>DerefMut</code>. Simply accessing components
via a mutable query, without actually performing a <code>&amp;mut</code> access, will <em>not</em>
trigger it.</p>
<p>This makes change detection quite accurate. You can rely on it to optimize
your game's performance, or to otherwise trigger things to happen.</p>
<p>Also note that when you mutate a component, Bevy does not track if the new
value is actually different from the old value. It will always trigger the
change detection. If you want to avoid that, simply check it yourself:</p>
<pre><code class="language-rust no_run noplayground">fn update_player_xp(
    mut query: Query&lt;&amp;mut PlayerXp&gt;,
) {
    for mut xp in query.iter_mut() {
        let new_xp = maybe_lvl_up(&amp;xp);

        // avoid triggering change detection if the value is the same
        if new_xp != *xp {
            *xp = new_xp;
        }
    }
}
</code></pre>
<p>Change detection is reliable -- it will detect any changes that
have occured since the last time your detecting system ran. If your
system only runs sometimes (such as with <a href="./states.html">states</a> or <a href="./run-criteria.html">run
criteria</a>), you <em>do not</em> have to worry about missing
changes.</p>
<h2 id="resources"><a class="header" href="#resources">Resources</a></h2>
<p>For resources, change detection is provided via methods on the
<code>Res</code>/<code>ResMut</code> system parameters.</p>
<pre><code class="language-rust no_run noplayground">fn check_res_changed(
    my_res: Res&lt;MyResource&gt;,
) {
    if my_res.is_changed() {
        // do something
    }
}

fn check_res_added(
    // use Option, not to panic if the resource doesn't exist yet
    my_res: Option&lt;Res&lt;MyResource&gt;&gt;,
) {
    if let Some(my_res) = my_res {
        // the resource exists

        if my_res.is_added() {
            // it was just added
            // do something
        }
    }
}
</code></pre>
<p>This works the same way as change detection for components.</p>
<h2 id="possible-pitfalls"><a class="header" href="#possible-pitfalls">Possible Pitfalls</a></h2>
<p>Beware of <a href="../pitfalls/frame-delay.html">frame delay / 1-frame-lag</a>. This can
occur if Bevy runs the detecting system before the changing system. The
detecting system will see the change the next time it runs, typically on
the next frame update.</p>
<p>If you need to ensure that changes are handled immediately / during the same
frame, you can use <a href="./system-order.html">explicit system ordering</a>.</p>
<p>However, when detecting component additions with <code>Added&lt;T&gt;</code> (which are
typically done using <a href="./commands.html"><code>Commands</code></a>), this is not enough;
you need <a href="./stages.html">stages</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../programming/system-sets.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../programming/states.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../programming/system-sets.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../programming/states.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../nagbar.js"></script>
    </body>
</html>
